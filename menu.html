<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>CYBER DRAGON ‚Äî Menu</title>
  <link rel="icon" href="logo.png"/>
  <style>
    :root{
      --bg:#0b0f1a; --text:#fff; --muted:#9fb3c8;
      --glass:rgba(255,255,255,.06); --glass-strong:rgba(16,22,36,.72);
      --line:rgba(255,255,255,.12);
      --brandA:#4fd3ff; --brandB:#8f00ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      font:16px/1.48 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      background: url('fon.png') center/cover fixed no-repeat, var(--bg);
      -webkit-tap-highlight-color:transparent;
    }
    /* –º—è–≥–∫–∏–µ –Ω–µ–æ–Ω–æ–≤—ã–µ –ø–µ—Ä–µ–ª–∏–≤—ã —Å–≤–µ—Ä—Ö—É/—Å–Ω–∏–∑—É */
    body::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:-1;
      background:
        radial-gradient(1100px 900px at 10% -10%, #4168ff22, transparent 60%),
        radial-gradient(1100px 900px at 90% 110%, #b34dff22, transparent 55%);
    }

    .app{max-width:430px;margin:0 auto;min-height:100dvh;
      padding:calc(14px + env(safe-area-inset-top)) 14px calc(28px + env(safe-area-inset-bottom));}

    /* Header */
    .header{position:sticky; top:0; z-index:30; margin:-6px -4px 8px}
    .bar{
      display:flex;align-items:center;gap:10px;padding:8px;border-radius:16px;
      background:linear-gradient(to bottom, rgba(10,15,26,.85), rgba(10,15,26,.5));
      border:1px solid var(--line); backdrop-filter:saturate(140%) blur(12px);
    }
    .brand{margin:0;font-size:1.06rem;letter-spacing:.35px;display:flex;align-items:center;gap:6px;font-weight:900}
    .brand .mark{height:18px;filter:drop-shadow(0 0 6px #9b5bff94)}
    .lang{margin-left:auto}
    .lang select{
      appearance:none;border-radius:10px;padding:10px 28px 10px 12px;min-height:44px;
      color:var(--text);background:var(--glass-strong);border:1px solid var(--line);outline:none
    }
    .burger{
      width:44px;height:44px;border-radius:12px;border:1px solid var(--line);
      background:var(--glass-strong);color:#fff;display:grid;place-items:center;cursor:pointer
    }
    .nav-pop{
      position:absolute;right:14px;top:64px;background:rgba(10,14,24,.94);backdrop-filter:blur(14px) saturate(140%);
      border:1px solid var(--line);border-radius:14px;padding:8px;display:none;min-width:220px;z-index:40
    }
    .nav-pop.open{display:block}
    .nav-pop a,.nav-pop .lang-inline{
      display:flex;align-items:center;gap:10px;padding:12px;border-radius:10px;color:#fff;text-decoration:none;min-height:44px
    }
    .nav-pop a:hover,.nav-pop .lang-inline:hover{background:var(--glass)}
    .nav-pop hr{border:0;height:1px;background:var(--line);margin:6px 0}
    .nav-pop .lang-inline select{flex:1;background:var(--glass-strong);border:1px solid var(--line);color:#fff;border-radius:10px;padding:8px 10px;min-height:44px}

    /* Category pills */
    .h-scroll{display:flex;gap:8px;overflow:auto;scroll-snap-type:x proximity;padding:6px 0}
    .pill{
      scroll-snap-align:start;white-space:nowrap;padding:10px 14px;border-radius:999px;border:1px solid var(--line);
      background:var(--glass);backdrop-filter:blur(8px);color:#fff;cursor:pointer;min-height:44px
    }
    .pill:active{transform:scale(.98)}
    .pill.active{background:linear-gradient(90deg,var(--brandA),var(--brandB));color:#001027;border:none;font-weight:800}

    /* GRID */
    .list{display:grid;gap:10px;margin-top:8px;grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{
      display:grid;grid-template-rows:auto auto auto;gap:8px;
      padding:10px;border-radius:18px;background:var(--glass);border:1px solid var(--line);backdrop-filter:blur(10px);
      position:relative;overflow:hidden
    }
    .thumb-wrap{position:relative}
    .thumb{width:100%;aspect-ratio:1/1;border-radius:20px;overflow:hidden;background:linear-gradient(135deg,#3a517f,#7a45cc)}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:block;border-radius:inherit}
    @supports (clip-path: inset(0 round 20px)){ .thumb{clip-path: inset(0 round 20px);} }
    .info{
      position:absolute;right:8px;top:8px;width:28px;height:28px;border-radius:999px;border:1px solid var(--line);
      background:var(--glass-strong);color:#fff;cursor:pointer;display:grid;place-items:center;font-weight:800
    }
    .name{font-weight:800;line-height:1.2;min-height:2.4em}
    .desc{display:none;color:var(--muted);font-size:.92rem}
    .card.expanded .desc{display:block}
    .foot{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .price{font-weight:800}
    .add{
      border:none;border-radius:999px;padding:10px 14px;background:linear-gradient(90deg,var(--brandA),var(--brandB));
      color:#001027;font-weight:800;cursor:pointer;min-height:40px;flex:1
    }
    .qty{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:999px;padding:6px 8px}
    .qty button{width:32px;height:32px;border:none;border-radius:10px;background:var(--glass-strong);color:#fff;cursor:pointer}

    /* FAB cart */
    .fab{position:sticky;bottom:calc(14px + env(safe-area-inset-bottom));display:flex;justify-content:center;margin-top:14px;z-index:35}
    .cart-fab{
      display:inline-flex;align-items:center;gap:10px;border:none;border-radius:999px;padding:12px 18px;cursor:pointer;color:#001027;
      background:linear-gradient(90deg,var(--brandA),var(--brandB));font-weight:800;box-shadow:0 18px 28px #001a2f66;min-height:48px
    }

    /* Sheet */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:.2s opacity;z-index:40}
    .overlay.show{opacity:1;pointer-events:auto}
    .sheet{
      position:fixed;left:0;right:0;bottom:0;width:100%;max-width:430px;margin:0 auto;
      background:rgba(10,14,24,.96);backdrop-filter:blur(16px) saturate(140%);
      border-top-left-radius:18px;border-top-right-radius:18px;border:1px solid var(--line);
      padding:14px;padding-bottom:calc(14px + env(safe-area-inset-bottom));
      transition:.25s transform; transform:translateY(100%);
      z-index:41; max-height:85dvh; overflow:auto; overscroll-behavior:contain;
    }
    .sheet.open{ transform:translateY(0) }
    .sheet h3{margin:0 0 8px}
    .cart-lines{display:grid;gap:10px;max-height:38dvh;overflow:auto;padding-right:4px}
    .line{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;padding:8px;border-radius:12px;border:1px dashed var(--line)}
    .section{margin-top:10px}
    .group{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:10px 14px;border-radius:999px;background:var(--glass);border:1px solid var(--line);cursor:pointer;min-height:44px}
    .chip.active{background:linear-gradient(90deg,var(--brandA),var(--brandB));color:#001027;border:none;font-weight:800}
    .field{display:grid;gap:6px;margin-top:8px}
    .field input,.field textarea,.field select{
      border-radius:10px;padding:12px;background:var(--glass-strong);color:#fff;border:1px solid var(--line);outline:none;font-size:1rem;min-height:44px
    }
    .field textarea{min-height:72px;resize:vertical}
    .checkout{display:grid;gap:8px;margin-top:10px}
    .btn{border:none;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;min-height:48px}
    .btn.primary{background:linear-gradient(90deg,var(--brandA),var(--brandB));color:#001027}
    .btn.ghost{background:transparent;border:1px dashed var(--line);color:#fff}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="bar">
        <h1 class="brand">CYBER <img class="mark" src="logo.png" alt="Logo"> DRAGON</h1>
        <div class="lang"><select id="langSel" aria-label="Language">
          <option value="ru">RU</option><option value="en">EN</option>
          <option value="ua">UA</option><option value="vn">VN</option>
          <option value="pl">PL</option><option value="de">DE</option>
          <option value="zh">ZH</option></select>
        </div>
        <button class="burger" id="burger" aria-haspopup="true" aria-expanded="false" aria-controls="navPop">‚ò∞</button>
        <nav class="nav-pop" id="navPop" role="menu" aria-label="Main menu">
          <a href="index.html" id="navHome" role="menuitem">üè† HOME</a>
          <a href="#" id="navMenu" role="menuitem">üçú MENU</a>
          <a href="#" id="navKaraoke" role="menuitem">üé§ KARAOKE</a>
          <a href="#" id="navContact" role="menuitem">üìû KONTAKT</a>
          <hr>
          <div class="lang-inline" role="none">üåê
            <select id="langSelMenu" aria-label="Language (menu)">
              <option value="ru">RU</option><option value="en">EN</option>
              <option value="ua">UA</option><option value="vn">VN</option>
              <option value="pl">PL</option><option value="de">DE</option>
              <option value="zh">ZH</option>
            </select>
          </div>
        </nav>
      </div>
    </header>

    <!-- Category pills -->
    <div class="h-scroll" id="catPills" aria-label="Categories"></div>

    <!-- Items grid -->
    <div class="list" id="list"></div>

    <!-- FAB Cart -->
    <div class="fab">
      <button class="cart-fab" id="cartFab" aria-haspopup="dialog">üõí <span id="fabText">0 —à—Ç. ‚Ä¢ 0.00 ‚Ç¨</span></button>
    </div>
  </div>

  <!-- Bottom Sheet -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <h3 id="sheetTitle"></h3>
    <div class="cart-lines" id="cartLines"></div>

    <div class="section">
      <div class="muted" id="orderTypeTitle" style="margin-bottom:6px">–¢–∏–ø –∑–∞–∫–∞–∑–∞</div>
      <div class="group" id="orderType">
        <button class="chip active" data-ot="on_site" id="otOnSite">–ù–∞ –º–µ—Å—Ç–µ</button>
        <button class="chip" data-ot="takeaway" id="otTakeaway">–ù–∞ –≤—ã–Ω–æ—Å</button>
        <button class="chip" data-ot="delivery" id="otDelivery">–î–æ—Å—Ç–∞–≤–∫–∞</button>
      </div>

      <div class="field" id="tableField" style="display:grid">
        <label for="tableNo" id="tableLbl">–°—Ç–æ–ª <span class="muted">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
        <input id="tableNo" type="number" min="1" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 5">
      </div>

      <div class="field" id="takeawayField" style="display:none">
        <label for="pickupIn" id="pickupLbl">–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –∑–∞–±—Ä–∞—Ç—å (–º–∏–Ω) <span class="muted">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
        <input id="pickupIn" type="number" min="5" step="5" placeholder="15">
      </div>

      <div class="field" id="addrField" style="display:none">
        <label for="address" id="addrLbl">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ <span class="muted">(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
        <textarea id="address" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º, –ø–æ–¥—ä–µ–∑–¥..."></textarea>
      </div>

      <div class="field" id="phoneField">
        <label for="phone" id="phoneLbl">–¢–µ–ª–µ—Ñ–æ–Ω <span class="muted" id="phoneHint">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span></label>
        <input id="phone" type="tel" placeholder="+48 600 000 000">
      </div>
    </div>

    <div class="checkout">
      <div class="muted" id="cartMeta">–ò—Ç–æ–≥–æ: 0.00 ‚Ç¨</div>
      <button class="btn primary" id="checkoutBtn">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
      <button class="btn ghost" id="clearBtn">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    </div>
  </div>

  <!-- DATA -->
  <script src="menu.js"></script>
  <script>
  /* ============ SETTINGS (Telegram) ============ */
  const TG = {
    BOT_TOKEN: "6819820426:AAEWwwN8tYLVPo6U-g6EjWCo4evnJ2SaGk4",    // <-- –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
    CHAT_ID: -1002156259709,                   // –∞–¥–º–∏–Ω —á–∞—Ç/–∫–∞–Ω–∞–ª
    PROXY_URL: ""                              // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å–≤–æ–π –ø—Ä–æ–∫—Å–∏ (–Ω–∞–ø—Ä. Cloudflare Worker) –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
  };
  const TG_ENDPOINT = (b)=> (TG.PROXY_URL || `https://api.telegram.org/bot${b}/sendMessage`);

  /* ============ BASIC CONFIG ============ */
  let LANG='ru'; document.documentElement.lang=LANG;
  const CURRENCY='‚Ç¨';
  const USE_IMAGES=true;
  const IMG_DIR='images/'; const IMG_EXTS=['webp','jpg','jpeg','png'];

  /* ============ I18N ============ */
  const I18N={};
  I18N.ru={navHome:'–ì–ª–∞–≤–Ω–∞—è',navMenu:'–ú–µ–Ω—é',navKaraoke:'–ö–∞—Ä–∞–æ–∫–µ',navContact:'–ö–æ–Ω—Ç–∞–∫—Ç—ã',
    sheetTitle:'–í–∞—à –∑–∞–∫–∞–∑',orderTypeTitle:'–¢–∏–ø –∑–∞–∫–∞–∑–∞',otOnSite:'–ù–∞ –º–µ—Å—Ç–µ',otTakeaway:'–ù–∞ –≤—ã–Ω–æ—Å',otDelivery:'–î–æ—Å—Ç–∞–≤–∫–∞',
    tableLbl:'–°—Ç–æ–ª',pickupLbl:'–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –∑–∞–±—Ä–∞—Ç—å (–º–∏–Ω)',addrLbl:'–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏',
    phoneLbl:'–¢–µ–ª–µ—Ñ–æ–Ω',phoneOptional:'(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',phoneRequired:'(–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)',
    total:'–ò—Ç–æ–≥–æ',checkout:'–û—Ñ–æ—Ä–º–∏—Ç—å',clear:'–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É',cartEmpty:'–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.',
    add:'–î–æ–±–∞–≤–∏—Ç—å',itemsShort:'—à—Ç.',alertTable:'–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞.',alertPickup:'–£–∫–∞–∂–∏—Ç–µ —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç –∑–∞–±—Ä–∞—Ç—å.',
    alertPhone:'–£–∫–∞–∂–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω.',alertAddr:'–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏.',orderAccepted:'–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç ‚úî',typeLabel:'–¢–∏–ø'};
  I18N.en={navHome:'Home',navMenu:'Menu',navKaraoke:'Karaoke',navContact:'Contact',
    sheetTitle:'Your order',orderTypeTitle:'Order type',otOnSite:'Dine-in',otTakeaway:'Takeaway',otDelivery:'Delivery',
    tableLbl:'Table',pickupLbl:'Pickup in (min)',addrLbl:'Delivery address',phoneLbl:'Phone',
    phoneOptional:'(optional)',phoneRequired:'(required)',total:'Total',checkout:'Checkout',clear:'Clear cart',
    cartEmpty:'Cart is empty.',add:'Add',itemsShort:'pcs',alertTable:'Please enter table number.',
    alertPickup:'Please enter pickup minutes.',alertPhone:'Please enter phone.',alertAddr:'Please enter delivery address.',
    orderAccepted:'Order accepted ‚úî',typeLabel:'Type'};
  I18N.ua={navHome:'–ì–æ–ª–æ–≤–Ω–∞',navMenu:'–ú–µ–Ω—é',navKaraoke:'–ö–∞—Ä–∞–æ–∫–µ',navContact:'–ö–æ–Ω—Ç–∞–∫—Ç–∏',
    sheetTitle:'–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è',orderTypeTitle:'–¢–∏–ø –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è',otOnSite:'–ù–∞ –º—ñ—Å—Ü—ñ',otTakeaway:'–ó —Å–æ–±–æ—é',otDelivery:'–î–æ—Å—Ç–∞–≤–∫–∞',
    tableLbl:'–°—Ç—ñ–ª',pickupLbl:'–ß–µ—Ä–µ–∑ —Å–∫—ñ–ª—å–∫–∏ –∑–∞–±—Ä–∞—Ç–∏ (—Ö–≤)',addrLbl:'–ê–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏',phoneLbl:'–¢–µ–ª–µ—Ñ–æ–Ω',
    phoneOptional:'(–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)',phoneRequired:'(–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)',total:'–†–∞–∑–æ–º',checkout:'–û—Ñ–æ—Ä–º–∏—Ç–∏',clear:'–û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫',
    cartEmpty:'–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π.',add:'–î–æ–¥–∞—Ç–∏',itemsShort:'—à—Ç.',alertTable:'–í–∫–∞–∂—ñ—Ç—å –Ω–æ–º–µ—Ä —Å—Ç–æ–ª—É.',
    alertPickup:'–í–∫–∞–∂—ñ—Ç—å —Ö–≤–∏–ª–∏–Ω–∏ –¥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è.',alertPhone:'–í–∫–∞–∂—ñ—Ç—å —Ç–µ–ª–µ—Ñ–æ–Ω.',alertAddr:'–í–∫–∞–∂—ñ—Ç—å –∞–¥—Ä–µ—Å—É.',
    orderAccepted:'–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç–æ ‚úî',typeLabel:'–¢–∏–ø'};
  I18N.pl={navHome:'Start',navMenu:'Menu',navKaraoke:'Karaoke',navContact:'Kontakt',
    sheetTitle:'Twoje zam√≥wienie',orderTypeTitle:'Rodzaj zam√≥wienia',otOnSite:'Na miejscu',otTakeaway:'Na wynos',otDelivery:'Dostawa',
    tableLbl:'Stolik',pickupLbl:'Za ile odebraƒá (min)',addrLbl:'Adres dostawy',phoneLbl:'Telefon',
    phoneOptional:'(opcjonalnie)',phoneRequired:'(wymagane)',total:'Razem',checkout:'Zam√≥w',clear:'Wyczy≈õƒá koszyk',
    cartEmpty:'Koszyk jest pusty.',add:'Dodaj',itemsShort:'szt.',alertTable:'Podaj numer stolika.',
    alertPickup:'Podaj liczbƒô minut.',alertPhone:'Podaj telefon.',alertAddr:'Podaj adres.',
    orderAccepted:'Zam√≥wienie przyjƒôte ‚úî',typeLabel:'Typ'};

  /* ============ Categories labels (–ø—Ä–∏–º–µ—Ä) ============ */
  const CAT_LABELS={
    'VORSPEISEN':{ru:'–ó–∞–∫—É—Å–∫–∏',en:'Starters',ua:'–ó–∞–∫—É—Å–∫–∏',pl:'Przystawki'},
    'HAUPTSPEISEN':{ru:'–û—Å–Ω–æ–≤–Ω—ã–µ –±–ª—é–¥–∞',en:'Mains',ua:'–û—Å–Ω–æ–≤–Ω—ñ —Å—Ç—Ä–∞–≤–∏',pl:'Dania g≈Ç√≥wne'},
    'SUSHI':{ru:'–°—É—à–∏',en:'Sushi',ua:'–°—É—à—ñ',pl:'Sushi'},
    'NACHSPEISEN':{ru:'–î–µ—Å–µ—Ä—Ç—ã',en:'Desserts',ua:'–î–µ—Å–µ—Ä—Ç–∏',pl:'Desery'},
    'BEILAGEN':{ru:'–ì–∞—Ä–Ω–∏—Ä—ã',en:'Sides',ua:'–ì–∞—Ä–Ω—ñ—Ä–∏',pl:'Dodatki'},
    'GETR√ÑNKE':{ru:'–ù–∞–ø–∏—Ç–∫–∏',en:'Drinks',ua:'–ù–∞–ø–æ—ó',pl:'Napoje'}
  };
  const catLabel=k=>(CAT_LABELS[k]?.[LANG]||CAT_LABELS[k]?.en||k);

  /* ============ Descriptions.json (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ============ */
  let DESCR={};
  async function loadDescriptions(){
    try{ const r=await fetch('descriptions.json',{cache:'no-store'}); if(r.ok) DESCR=await r.json(); }catch(e){}
  }

  /* ============ Helpers ============ */
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const fmt=n=>Number(n).toFixed(2)+' '+CURRENCY;
  const itemName=it=>it.translations?.[LANG]||it.translations?.en||it.key.replaceAll('_',' ');
  const getDesc=it=>{
    const fromJson=DESCR[it.key]?.description;
    return (fromJson && (fromJson[LANG]||fromJson.en)) || it.short || it.description || '';
  };
  function buildThumb(imgEl,key){
    let i=0; const trySet=()=>imgEl.src=IMG_DIR+key+'.'+IMG_EXTS[i];
    imgEl.onerror=()=>{ i++; if(i<IMG_EXTS.length){ trySet(); } else { imgEl.closest('.thumb')?.classList.add('noimg'); imgEl.remove(); } };
    trySet();
  }

  /* ============ State ============ */
  const cart=new Map(); let currentCat=null;

  /* ============ Render ============ */
  function renderPills(){
    const keys=Object.keys(menuData); currentCat=currentCat||keys[0];
    const wrap=$('#catPills');
    wrap.innerHTML=keys.map(k=>`<button class="pill ${k===currentCat?'active':''}" data-cat="${k}">${catLabel(k)}</button>`).join('');
    wrap.onclick=e=>{
      const b=e.target.closest('.pill'); if(!b) return;
      $$('#catPills .pill').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); currentCat=b.dataset.cat; renderList();
    };
  }

  function renderList(){
    const wrap=$('#list'); const items=menuData[currentCat]||[]; const L=I18N[LANG];
    wrap.innerHTML=items.map((it,idx)=>{
      const name=itemName(it); const id=`${currentCat}:${idx}`; const qty=cart.get(id)||0; const price=it.price??0;
      const btn=qty
        ? `<div class="qty" data-qty="${id}"><button data-dec="${id}">‚àí</button><span>${qty}</span><button data-inc="${id}">+</button></div>`
        : `<button class="add" data-add="${id}">${L.add}</button>`;
      const descText=getDesc(it);
      return `
      <div class="card" data-id="${id}">
        <div class="thumb-wrap">
          <div class="thumb">${USE_IMAGES?`<img loading="lazy" decoding="async" alt="${name}">`:''}</div>
          <button class="info" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ" data-toggle="${id}">i</button>
        </div>
        <div class="name">${name}</div>
        ${descText?`<p class="desc">${descText}</p>`:''}
        <div class="foot">
          <div class="price">${fmt(price)}</div>
          ${btn}
        </div>
      </div>`;
    }).join('');

    if(USE_IMAGES){
      wrap.querySelectorAll('.card').forEach(row=>{
        const id=row.getAttribute('data-id'); const [cat,idx]=id.split(':');
        const key=(menuData[cat]?.[+idx]?.key)||''; const img=row.querySelector('.thumb img');
        if(img && key) buildThumb(img,key);
      });
    }
  }

  function renderCartSheet(){
    const lines=$('#cartLines'); const L=I18N[LANG];
    if(cart.size===0){lines.innerHTML=`<div class="muted">${L.cartEmpty}</div>`; $('#cartMeta').textContent=`${L.total}: `+fmt(0); return;}
    let sum=0; lines.innerHTML='';
    for(const [id,qty] of cart){
      const [cat,idx]=id.split(':'); const it=menuData[cat]?.[+idx]; if(!it) continue;
      const name=itemName(it); const lineSum=(it.price||0)*qty; sum+=lineSum;
      const el=document.createElement('div'); el.className='line';
      el.innerHTML=`<div><strong>${name}</strong><div class="muted">${fmt(it.price||0)} √ó ${qty}</div></div>
        <div class="qty" data-qty="${id}"><button data-dec="${id}">‚àí</button><span>${qty}</span><button data-inc="${id}">+</button></div>`;
      lines.appendChild(el);
    }
    $('#cartMeta').textContent=`${L.total}: `+fmt(sum);
  }

  function renderFab(){
    let items=0,sum=0;
    for(const [id,qty] of cart){ const [cat,idx]=id.split(':'); const it=menuData[cat]?.[+idx]; if(!it) continue; items+=qty; sum+=(it.price||0)*qty; }
    $('#fabText').textContent=`${items} ${I18N[LANG].itemsShort} ‚Ä¢ ${fmt(sum)}`;
  }

  /* ============ UI texts ============ */
  function setUITexts(){
    const L=I18N[LANG];
    $('#navHome').textContent=`üè† ${L.navHome}`;
    $('#navMenu').textContent=`üçú ${L.navMenu}`;
    $('#navKaraoke').textContent=`üé§ ${L.navKaraoke}`;
    $('#navContact').textContent=`üìû ${L.navContact}`;
    $('#sheetTitle').textContent=L.sheetTitle;
    $('#orderTypeTitle').textContent=L.orderTypeTitle;
    $('#otOnSite').textContent=L.otOnSite;
    $('#otTakeaway').textContent=L.otTakeaway;
    $('#otDelivery').textContent=L.otDelivery;
    $('#tableLbl').innerHTML=`${L.tableLbl} <span class="muted">${L.phoneRequired}</span>`;
    $('#pickupLbl').innerHTML=`${L.pickupLbl} <span class="muted">${L.phoneRequired}</span>`;
    $('#addrLbl').innerHTML=`${L.addrLbl} <span class="muted">${L.phoneRequired}</span>`;
  }

  /* ============ Events ============ */
  document.addEventListener('click', e=>{
    const add=e.target.closest('[data-add]'); if(add){const id=add.dataset.add; cart.set(id,(cart.get(id)||0)+1); renderList(); renderFab(); return;}
    const inc=e.target.closest('[data-inc]'); if(inc){const id=inc.dataset.inc; cart.set(id,(cart.get(id)||0)+1); renderList(); renderCartSheet(); renderFab(); return;}
    const dec=e.target.closest('[data-dec]'); if(dec){const id=dec.dataset.dec; const q=(cart.get(id)||0)-1; if(q<=0) cart.delete(id); else cart.set(id,q); renderList(); renderCartSheet(); renderFab(); return;}

    const info=e.target.closest('[data-toggle]');
    const card=info ? document.querySelector(`.card[data-id="${info.dataset.toggle}"]`) : e.target.closest('.card');
    if(card && !e.target.closest('.add') && !e.target.closest('.qty')){ card.classList.toggle('expanded'); return; }

    if(e.target.closest('#cartFab')){
      document.body.style.overflow='hidden';
      $('#overlay').classList.add('show'); const sh=$('#sheet'); sh.classList.add('open'); sh.scrollTop=0;
      renderCartSheet(); return;
    }
    if(e.target.id==='overlay'){ closeSheet(); }
    if(e.target.id==='clearBtn'){ cart.clear(); renderList(); renderCartSheet(); renderFab(); }
  });

  function closeSheet(){
    document.body.style.overflow='';
    $('#overlay').classList.remove('show'); $('#sheet').classList.remove('open');
  }

  // burger
  const burger=$('#burger'), navPop=$('#navPop');
  burger.addEventListener('click',()=>{const open=navPop.classList.toggle('open'); burger.setAttribute('aria-expanded',String(open));});
  document.addEventListener('click',e=>{if(!navPop.contains(e.target)&&e.target!==burger){navPop.classList.remove('open'); burger.setAttribute('aria-expanded','false');}});

  // order type
  const otWrap=$('#orderType'), tableField=$('#tableField'), takeawayField=$('#takeawayField'), addrField=$('#addrField');
  const tableNo=$('#tableNo'), pickupIn=$('#pickupIn'), address=$('#address'), phone=$('#phone'), phoneHint=$('#phoneHint');
  function show(el,on){el.style.display=on?'grid':'none'}
  function setPhoneHint(req){phoneHint.textContent=req?I18N[LANG].phoneRequired:I18N[LANG].phoneOptional}
  function setOrderType(v){
    if(v==='on_site'){show(tableField,true);show(takeawayField,false);show(addrField,false);setPhoneHint(false);tableNo.required=true;pickupIn.required=false;address.required=false;}
    else if(v==='takeaway'){show(tableField,false);show(takeawayField,true);show(addrField,false);setPhoneHint(true);tableNo.required=false;pickupIn.required=true;address.required=false;}
    else{show(tableField,false);show(takeawayField,false);show(addrField,true);setPhoneHint(true);tableNo.required=false;pickupIn.required=false;address.required=true;}
  }
  otWrap.addEventListener('click',e=>{const b=e.target.closest('[data-ot]'); if(!b) return; $$('#orderType .chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); setOrderType(b.dataset.ot);});

  // language
  const selA=$('#langSel'), selB=$('#langSelMenu');
  function setLang(v){ LANG=v; document.documentElement.lang=v; selA.value=v; selB.value=v; setUITexts(); renderPills(); renderList(); renderCartSheet(); renderFab(); const active=document.querySelector('#orderType .chip.active')?.dataset.ot||'on_site'; setOrderType(active); }
  selA.addEventListener('change',e=>setLang(e.target.value));
  selB.addEventListener('change',e=>setLang(e.target.value));

  /* ============ Checkout + Telegram ============ */
  function cartSummary(){
    let items=0,sum=0, lines=[];
    for(const [id,qty] of cart){
      const [cat,idx]=id.split(':'); const it=menuData[cat]?.[+idx]; if(!it) continue;
      const name=itemName(it); const price=Number(it.price||0); items+=qty; sum+=price*qty;
      lines.push(`‚Ä¢ ${name} ‚Äî ${price.toFixed(2)} ${CURRENCY} √ó ${qty}`);
    }
    return {items,sum,lines};
  }

  async function sendOrderToTelegram(text){
    if(!TG.BOT_TOKEN){ console.warn('BOT_TOKEN –ø—É—Å—Ç'); return {ok:false, reason:'no-token'}; }
    const url = TG_ENDPOINT(TG.BOT_TOKEN);
    // –ï—Å–ª–∏ –≤–∞—à Bot API —Ä–µ–∂–µ—Ç CORS, —É–∫–∞–∂–∏—Ç–µ TG.PROXY_URL (–≤–∞—à worker/–ø—Ä–æ–∫—Å–∏)
    const payload = {chat_id: TG.CHAT_ID, text, parse_mode: "HTML", disable_web_page_preview: true};
    try{
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      // –µ—Å–ª–∏ —á–µ—Ä–µ–∑ proxy —Å CORS –≤—Å—ë –æ–∫ ‚Äî –ø–æ–ª—É—á–∏–º JSON
      if(r.ok){ return {ok:true, status:r.status}; }
      // fallback: –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å no-cors (–æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç opaque)
      await fetch(url, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
      return {ok:true, status:'opaque'};
    }catch(err){
      console.error('TG send fail', err);
      return {ok:false, reason:String(err)};
    }
  }

  $('#checkoutBtn').addEventListener('click', async ()=>{
    const L=I18N[LANG]; const ot=document.querySelector('#orderType .chip.active')?.dataset.ot;
    if(ot==='on_site'){ if(!tableNo.value.trim()){alert(L.alertTable);return;} }
    else if(ot==='takeaway'){ if(!pickupIn.value.trim()){alert(L.alertPickup);return;} if(!phone.value.trim()){alert(L.alertPhone);return;} }
    else { if(!address.value.trim()){alert(L.alertAddr);return;} if(!phone.value.trim()){alert(L.alertPhone);return;} }

    const {items,sum,lines}=cartSummary();
    const typeStr = I18N[LANG][ ot==='on_site'?'otOnSite': ot==='takeaway'?'otTakeaway':'otDelivery' ];
    const meta = [];
    if(ot==='on_site') meta.push(`${I18N[LANG].tableLbl}: ${tableNo.value.trim()}`);
    if(ot==='takeaway') meta.push(`${I18N[LANG].pickupLbl}: ${pickupIn.value.trim()} min`);
    if(ot==='delivery') meta.push(`${I18N[LANG].addrLbl}: ${address.value.trim()}`);
    if(phone.value.trim()) meta.push(`${I18N[LANG].phoneLbl}: ${phone.value.trim()}`);
    const ordId = 'CD-' + new Date().toISOString().replace(/[-:TZ.]/g,'').slice(0,14);

    const text =
`<b>CYBER DRAGON ‚Äî –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</b>
ID: <code>${ordId}</code>
${I18N[LANG].total}: <b>${sum.toFixed(2)} ${CURRENCY}</b>
${I18N[LANG].typeLabel}: <b>${typeStr}</b>
${meta.join('\n')}

<b>–ü–æ–∑–∏—Ü–∏–∏:</b>
${lines.join('\n')}`;

    const res = await sendOrderToTelegram(text);
    alert((res.ok?L.orderAccepted:'OK, –Ω–æ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ') + `\nID: ${ordId}\n–°—É–º–º–∞: ${sum.toFixed(2)} ${CURRENCY}`);
    cart.clear(); renderList(); renderCartSheet(); renderFab(); closeSheet();
  });

  /* ============ INIT ============ */
  (async ()=>{
    await loadDescriptions();
    setLang(LANG);
    renderPills(); renderList(); renderFab(); setOrderType('on_site');
  })();
  </script>
</body>
</html>
